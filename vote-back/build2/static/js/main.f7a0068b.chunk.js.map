{"version":3,"sources":["CurrentUserInfo.js","RequireLogin.js","hooks.js","Login.js","Register.js","Create.js","MyVotes.js","Main.js","CreateVote.js","ViewVote.js","App.js","index.js"],"names":["UserContext","createContext","CurrentUserInfo","children","userInfo","useAxios","url","Provider","value","RequireLogin","to","useInput","init","useState","setValue","onChange","useCallback","e","target","config","data","setData","error","setError","loading","setLoading","i","setI","useEffect","source","axios","CancelToken","cancelToken","token","then","res","code","result","msg","catch","toString","cancel","update","useUser","useContext","forceLogin","Comp","ForceLoginComp","props","displayName","name","Login","password","history","useHistory","a","info","post","goBack","alert","type","onClick","Register","Create","className","map","vote","voteId","title","style","color","multiple","anonymous","Main","path","exact","component","MyVotes","useImmer","options","setOptions","desc","deadline","useMemo","dayjs","add","format","checked","setChecked","useBooleanInput","query","search","useLocation","URLSearchParams","useQuery","get","console","log","createdVote","push","placeholder","option","idx","val","setOption","tabIndex","splice","remove","useParams","userVotes","setUserVotes","selectedOptionIds","setSelectedOptionIds","voteOption","optionId","optionIds","handleOptionClick","votes","some","it","userId","includes","indexOf","selectOption","Date","now","getTime","wsUrl","window","location","protocol","replace","host","ws","WebSocket","onmessage","JSON","parse","close","groupedVotes","_","groupBy","uniqueUserCount","uniqBy","length","thisOptionVotes","content","toFixed","oneVote","disabled","ReactRouter","App","ViewVote","CreateVote","ReactDOM","render","StrictMode","document","getElementById"],"mappings":"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","file":"static/js/main.f7a0068b.chunk.js","sourcesContent":["import { createContext } from \"react\";\r\nimport { useAxios } from \"./hooks\";\r\n\r\nexport var UserContext = createContext()\r\n\r\nexport default function CurrentUserInfo({ children }) {\r\n\r\n  var userInfo = useAxios({ url: '/account/current-user' })\r\n\r\n\r\n  return (\r\n    <UserContext.Provider value={userInfo}>\r\n      {children}\r\n    </UserContext.Provider>\r\n  )\r\n}\r\n","\r\nimport { Link } from 'react-router-dom'\r\n\r\nexport default function RequireLogin() {\r\n  return (\r\n    <div>\r\n      <h2>需要登陆</h2>\r\n      <Link to=\"/login\">登陆</Link>\r\n    </div>\r\n  )\r\n}\r\n","import { useState, useCallback, useMemo, useEffect, useContext } from 'react'\r\nimport { UserContext } from './CurrentUserInfo'\r\nimport { useLocation } from 'react-router-dom'\r\nimport axios from 'axios'\r\nimport RequireLogin from './RequireLogin'\r\n\r\n\r\nexport function useInput(init = '') {\r\n  var [value, setValue] = useState(init)\r\n\r\n  var onChange = useCallback(function onChange(e) {\r\n    setValue(e.target.value)\r\n  }, [])\r\n\r\n  return {\r\n    value, onChange\r\n  }\r\n}\r\n\r\nexport function useBooleanInput(init = false) {\r\n  var [checked, setChecked] = useState(init)\r\n\r\n  var onChange = useCallback(function onChange(e) {\r\n    setChecked(e.target.checked)\r\n  }, [])\r\n\r\n  return {checked, onChange}\r\n}\r\n\r\nexport function useQuery() {\r\n  var search = useLocation().search\r\n  return useMemo(() => new URLSearchParams(search), [search])\r\n}\r\n\r\nexport function useAxios(config) {\r\n  var [data, setData] = useState() // 用来存放请求结果的\r\n  var [error, setError] = useState() // 用来存放错误结果的\r\n  var [loading, setLoading] = useState(true) // 用来存放是否还在加载中\r\n  var [i, setI] = useState(0)\r\n\r\n  useEffect(() => {\r\n    const CancelToken = axios.CancelToken;\r\n    const source = CancelToken.source();\r\n\r\n    var req = axios({\r\n      ...config,\r\n      cancelToken: source.token\r\n    })\r\n\r\n    req.then(res => {\r\n      if (res.data.code == 0) {\r\n        setData(res.data.result)\r\n        setError(null)\r\n      } else {\r\n        setError(res.data.msg)\r\n      }\r\n      setLoading(false)\r\n    }).catch(e => {\r\n      setError(e.toString())\r\n      setLoading(false)\r\n    })\r\n\r\n    return () => source.cancel()\r\n  }, [config.url, i])\r\n\r\n  var update = useCallback(function update() {\r\n    setLoading(true)\r\n    setI(i => i + 1)\r\n  }, [])\r\n\r\n  return {\r\n    data,\r\n    loading,\r\n    error,\r\n    update,\r\n  }\r\n}\r\n\r\n\r\n\r\n\r\n// 拿到当前登陆用户的业务hook\r\nexport function useUser() {\r\n  return useContext(UserContext)\r\n}\r\n\r\n\r\n// 强制登陆的高阶组件，用它包裹的组件必须登陆才能显示\r\nexport function forceLogin(Comp) {\r\n  function ForceLoginComp(props) {\r\n    var userInfo = useUser()\r\n    if (userInfo.loading) {\r\n      return null\r\n    }\r\n    if (userInfo.error) {\r\n      return <RequireLogin />\r\n    }\r\n    return <Comp {...props} userInfo={userInfo}/>\r\n  }\r\n\r\n  ForceLoginComp.displayName = 'ForceLogin' + (Comp.displayName ?? Comp.name)\r\n\r\n  return ForceLoginComp\r\n}\r\n","\r\nimport axios from 'axios'\r\nimport { useEffect } from 'react'\r\nimport { useHistory } from 'react-router-dom'\r\nimport { useInput, useUser } from './hooks'\r\n\r\n\r\nexport default function Login() {\r\n  var name = useInput()\r\n  var password = useInput()\r\n  var history = useHistory()\r\n  var userInfo = useUser()\r\n\r\n  useEffect(() => {\r\n    if (userInfo.data) {\r\n      history.goBack()\r\n    }\r\n  })\r\n\r\n  async function login() {\r\n    var info = {\r\n      name: name.value,\r\n      password: password.value,\r\n    }\r\n\r\n    try {\r\n      var res = await axios.post('/account/login', info) // axios返回的是响应对象\r\n      // let data = res.data // 响应体在响应对象的data字段上\r\n      userInfo.update()\r\n      history.goBack()\r\n    } catch (e) {// 请求成功，但响应码大于等于400在axios里也算失败；网络原因直接请求失败，也会抛\r\n      let data = res.data\r\n      alert(data.msg)\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div>\r\n      <div>用户名：</div>\r\n      <input type=\"text\" {...name}/>\r\n      <div>密码：</div>\r\n      <input type=\"password\" {...password}/>\r\n      <div><button onClick={login}>登陆</button></div>\r\n    </div>\r\n  )\r\n}\r\n","\r\n\r\nexport default function Register() {\r\n\r\n\r\n\r\n  return (\r\n    <div>\r\n      <div>用户名：</div>\r\n      <input type=\"text\" />\r\n      <div>密码：</div>\r\n      <input type=\"password\" />\r\n      <div>Email</div>\r\n      <input type=\"text\" />\r\n\r\n      <div><button>注册</button></div>\r\n    </div>\r\n  )\r\n}\r\n","// 选创建单选还是多选的界面\r\nimport { Link } from 'react-router-dom'\r\nimport './Create.css'\r\n\r\nexport default function Create() {\r\n\r\n  return (\r\n    <div>\r\n    <div className=\"card\">\r\n      <Link to=\"/create-vote\">\r\n        <img className=\"card-img\" />\r\n        创建单选\r\n      </Link>\r\n    </div>\r\n      <div className=\"card\">\r\n        <Link to=\"/create-vote?multiple=1\">\r\n          <img className=\"card-img\" />\r\n          创建多选\r\n        </Link>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","import { Link } from \"react-router-dom\"\r\nimport { forceLogin, useAxios } from \"./hooks\"\r\n\r\n\r\nfunction MyVotes({ userInfo }) {\r\n  var { loading, data, error, update } = useAxios({ url: '/vote' })\r\n\r\n  if (loading) return null\r\n\r\n  return (\r\n    <div>\r\n      我的投票\r\n      <ul>\r\n        {\r\n          data.map(vote => {\r\n            return (\r\n              <li key={vote.voteId}>\r\n                <Link to={\"/view-vote/\" + vote.voteId}>{vote.title}</Link>\r\n\r\n                <span style={{color: '#3269da'}}>[{vote.multiple ? '多选' : '单选'}]</span>\r\n                <span style={{color: '#3269da'}}>[{vote.anonymous ? '匿名' : '公开'}]</span>\r\n              </li>\r\n            )\r\n          })\r\n        }\r\n      </ul>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default forceLogin(MyVotes)\r\n","\r\nimport { NavLink, Route, Redirect} from 'react-router-dom'\r\n\r\nimport Create from './Create'\r\nimport MyVotes from './MyVotes'\r\n\r\n\r\nexport default function Main() {\r\n\r\n\r\n  return (\r\n    <div>\r\n\r\n      <Route path=\"/main\" exact>\r\n        <Redirect to=\"/main/create\" />\r\n      </Route>\r\n      <Route path=\"/main/create\" component={Create}/>\r\n      <Route path=\"/main/myvotes\" component={MyVotes}/>\r\n\r\n      <nav>\r\n        <NavLink to=\"/main/create\">新建</NavLink>\r\n        {\" | \"}\r\n        <NavLink to=\"/main/myvotes\">我的</NavLink>\r\n      </nav>\r\n    </div>\r\n  )\r\n}\r\n","// 真正用于创建投票的界面\r\n\r\nimport { useImmer } from 'use-immer'\r\nimport { useMemo } from 'react'\r\nimport { useInput, useBooleanInput, useQuery, forceLogin } from './hooks'\r\nimport { useHistory } from 'react-router-dom'\r\nimport axios from 'axios'\r\nimport dayjs from 'dayjs'\r\n\r\nfunction CreateVote({ userInfo }) {\r\n  var [options, setOptions] = useImmer(['', ''])\r\n  var title = useInput()\r\n  var desc = useInput()\r\n  var deadline = useInput(useMemo(() => dayjs().add(1, 'year').format('YYYY-MM-DDTHH:mm'), []))\r\n  var anonymous = useBooleanInput()\r\n  var history = useHistory()\r\n  var query = useQuery()\r\n\r\n  function remove(idx) {\r\n    setOptions(options => {\r\n      options.splice(idx, 1)\r\n    })\r\n  }\r\n\r\n  function setOption(idx, val) {\r\n    setOptions(options => {\r\n      options[idx] = val\r\n    })\r\n  }\r\n\r\n  async function create() {\r\n    var vote = {\r\n      title: title.value,\r\n      desc: desc.value,\r\n      options: options,\r\n      deadline: deadline.value,\r\n      anonymous: anonymous.checked,\r\n      multiple: query.get('multiple') === '1' ? true : false,\r\n    }\r\n    console.log(vote)\r\n\r\n    try {\r\n      debugger\r\n\r\n      var res = await axios.post('/vote', vote)\r\n      var createdVote = res.data.result // data里应该有创建好的投票信息，如：创建者，投票id\r\n      console.log(createdVote)\r\n      history.push('/view-vote/' + createdVote.voteId)\r\n    } catch (e) {\r\n      throw e\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div>\r\n      <h1>创建投票</h1>\r\n      <div><input type=\"text\" placeholder=\"投票标题\" {...title}/></div>\r\n      <div><input type=\"text\" placeholder=\"补充描述(选填)\" {...desc}/></div>\r\n\r\n      {\r\n        options.map((option, idx) =>\r\n          <div key={idx}>\r\n            <input type=\"text\" placeholder=\"选项\" value={option} onChange={e => setOption(idx, e.target.value)}/>\r\n            <button tabIndex=\"-1\" onClick={() => remove(idx)}>-</button>\r\n          </div>\r\n        )\r\n      }\r\n      <div><button onClick={() => setOptions(options => { options.push('') })}>添加选项</button></div>\r\n      <div>截止日期:<input type=\"datetime-local\" {...deadline} /></div>\r\n      <div>匿名投票:<input type=\"checkbox\" {...anonymous} /></div>\r\n      <div><button onClick={create}>创建投票</button></div>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default forceLogin(CreateVote)\r\n","// 投票查看及交互页面\r\n\r\nimport { useParams } from \"react-router-dom\"\r\nimport axios from \"axios\"\r\nimport { useEffect, useState, useMemo } from \"react\"\r\nimport { forceLogin, useAxios } from './hooks'\r\nimport './ViewVote.css'\r\nimport _ from 'lodash'\r\nimport dayjs from 'dayjs'\r\nimport { useImmer } from \"use-immer\"\r\n\r\n\r\n\r\n/**\r\n * 投票页面的信息是实时更新的\r\n * 实现这个需求有两种方案：\r\n * 一是页面加载成功后一直不断的发ajax请求来获取最新的数据，并展示出来\r\n *  这种做法在投票已经创建出很久以后就不够好了，因为如果创建出很久以后，大概率是不会更新的\r\n *  发出请求大概率是没有获取到最新信息的\r\n * 第二种方案为http长连接，也叫comet，即服务器在收到客户端发来的ajax请求后\r\n *  如果没有数据要回复给客户端，则服务器hold住这个连接，直到超时后响应空内容，或在有数据后立刻响应该请求\r\n *    微信/钉钉的登陆都是这个方案\r\n * 第三种：websocket\r\n *  页面加载成功后向服务器建立一个websocket连接，如果服务器有新的数据，则直接在这个ws连接上响应客户端\r\n *    而不用客户端主动的一直发请求\r\n *\r\n *\r\n *\r\n */\r\nfunction ViewVote({ userInfo }) {\r\n  var { voteId } = useParams()\r\n  var { loading, data, error, update } = useAxios({ url: `/vote/${voteId}` })\r\n  var [userVotes, setUserVotes] = useState() // 从websocket上获取到的实时信息\r\n  var [selectedOptionIds, setSelectedOptionIds] = useImmer([])\r\n\r\n  useEffect(() => {\r\n    // debugger\r\n    // 如果还在加载，或者是超过截止时间，则什么也不做\r\n    if (loading || Date.now() > new Date(data.vote.deadline).getTime()) {\r\n      return\r\n    }\r\n\r\n    var wsUrl = `${window.location.protocol.replace('http', 'ws')}//${window.location.host}/realtime-voteinfo/${voteId}`\r\n    // var wsUrl = `ws://localhost:8081/realtime-voteinfo/${voteId}`\r\n\r\n    console.log(wsUrl)\r\n    var ws = new WebSocket(wsUrl)\r\n\r\n    // 服务器发来的就是当前投票的最新投票信息\r\n    ws.onmessage = function (e) {\r\n      var data = JSON.parse(e.data)\r\n      console.log('从websocket获取到的实时投票信息', data)\r\n      setUserVotes(data)\r\n    }\r\n\r\n    return () => ws.close()\r\n  }, [loading, voteId])\r\n\r\n  // 为某个选项投票/或取消投票\r\n  async function voteOption(option) {\r\n    if (!data.vote.anonymous) {\r\n      var { optionId } = option\r\n      await axios.post(`/vote/${voteId}`, {\r\n        optionIds: [optionId]\r\n      })\r\n    } else { // 匿名的话，发选中的\r\n      await axios.post(`/vote/${voteId}`, {\r\n        optionIds: selectedOptionIds\r\n      })\r\n      setSelectedOptionIds([])\r\n    }\r\n  }\r\n\r\n  function selectOption(option) {\r\n    var { optionId } = option\r\n    if (selectedOptionIds.includes(optionId)) {\r\n      setSelectedOptionIds(selectedOptionIds => {\r\n        var idx = selectedOptionIds.indexOf(optionId)\r\n        selectedOptionIds.splice(idx, 1)\r\n      })\r\n    } else {\r\n      setSelectedOptionIds(selectedOptionIds => {\r\n        selectedOptionIds.push(optionId)\r\n      })\r\n    }\r\n  }\r\n\r\n  function handleOptionClick(option) {\r\n    if (data.vote.anonymous) {\r\n      if (votes.some(it => it.userId === userInfo.data.userId)) {\r\n        return\r\n      }\r\n      selectOption(option)\r\n    } else {\r\n      voteOption(option)\r\n    }\r\n  }\r\n\r\n  var votes = userVotes ?? data?.userVotes ?? []\r\n\r\n  var groupedVotes    = useMemo(() => _.groupBy(votes, 'optionId'), [votes])\r\n  var uniqueUserCount = useMemo(() => _.uniqBy(votes, 'userId').length, [votes]) // 去重后用户数量\r\n\r\n  // console.log('分组后的投票数据', groupedVotes)\r\n  // console.log('去重后的投票人数', uniqueUserCount)\r\n\r\n  if (loading) return 'Loading...'\r\n\r\n  return (\r\n    <div>\r\n      <h2>{data.vote.title}</h2>\r\n      <span style={{color: '#3269da'}}>[{data.vote.multiple ? '多选' : '单选'}]</span>\r\n      <span style={{color: '#3269da'}}>[{data.vote.anonymous ? '匿名' : '公开'}]</span>\r\n      <h3>{data.vote.desc}</h3>\r\n      <ul>\r\n        {\r\n          data.options.map(option => {\r\n            // option 是选项本身\r\n            // 当前选项的票数信息\r\n            var thisOptionVotes = groupedVotes[option.optionId] || []\r\n\r\n            return (\r\n              <li onClick={() => handleOptionClick(option)} key={option.optionId}>\r\n                {option.content}\r\n                [{thisOptionVotes.length}票]\r\n                [{uniqueUserCount == 0 ? 0 : (thisOptionVotes.length / uniqueUserCount * 100).toFixed(2)}%]\r\n\r\n                {/* 当选选项的任意一票是当前登陆用户，则说明当前用户已经选择该选项 */}\r\n                {thisOptionVotes.some(it => it.userId == userInfo.data.userId) ? '✔️' : ''}\r\n\r\n                {selectedOptionIds.includes(option.optionId) ? '✔️' : ''}\r\n\r\n                <div/>\r\n                {/* {\r\n                  thisOptionVotes.map(oneVote => {\r\n                    return <img width=\"32\" height=\"32\" src={oneVote.avatar ?? 'https://www.12306.cn/index/images/service.png'} style={{borderRadius: '9999px', margin: '2px'}} />\r\n                  })\r\n                } */}\r\n                {\r\n                  thisOptionVotes.map(oneVote => {\r\n                    return <span key={oneVote.userId} className=\"user-id\">{oneVote.userId}</span>\r\n                  })\r\n                }\r\n              </li>\r\n            )\r\n          })\r\n        }\r\n      </ul>\r\n\r\n      {/* 匿名且当前用户没投过才显示确定投票 */}\r\n      {!!data.vote.anonymous && !votes.some(it => it.userId == userInfo.data.userId) &&\r\n        <button disabled={!selectedOptionIds.length} onClick={voteOption}>确定投票</button>\r\n      }\r\n\r\n      <p>投票截止: {dayjs(data.vote.deadline).format('YYYY-MM-DD HH:mm')}</p>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default forceLogin(ViewVote)\r\n","import './App.css';\nimport * as ReactRouter from 'react-router-dom'\nimport { Switch, Route, NavLink, MemoryRouter as HashRouter, Redirect } from 'react-router-dom';\nimport Login from './Login';\nimport Register from './Register';\nimport Main from './Main';\nimport CreateVote from './CreateVote';\nimport ViewVote from './ViewVote';\nimport CurrentUserInfo from './CurrentUserInfo'\n\nconsole.log(ReactRouter)\n\nfunction App() {\n  return (\n    <CurrentUserInfo>\n      <HashRouter>\n        <div className=\"App\">\n\n          <Switch>\n            <Route path=\"/\" exact>\n              <Redirect to=\"/main\" />\n            </Route>\n            <Route path=\"/main\" component={Main}>\n            </Route>\n            <Route path=\"/login\" component={Login}/>\n            <Route path=\"/register\" component={Register}/>\n            <Route path=\"/view-vote/:voteId\" component={ViewVote}/>\n            <Route path=\"/create-vote\" component={CreateVote}/>\n          </Switch>\n\n        </div>\n      </HashRouter>\n    </CurrentUserInfo>\n  );\n}\n\nexport default App;\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport './index.css';\nimport App from './App';\n\nReactDOM.render(\n  <React.StrictMode>\n    <App />\n  </React.StrictMode>,\n  document.getElementById('root')\n);\n"],"sourceRoot":""}